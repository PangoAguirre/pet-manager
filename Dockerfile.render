FROM docker:24-dind

# Instalar dependencias
RUN apk add --no-cache \
    curl \
    bash \
    python3 \
    py3-pip \
    docker-compose

# Instalar docker-compose
RUN pip3 install docker-compose

# Crear directorio de trabajo
WORKDIR /app

# Copiar archivos del proyecto
COPY . .

# Copiar configuraciÃ³n de docker-compose para producciÃ³n
COPY docker-compose.production.yml docker-compose.yml

# Copiar configuraciÃ³n de nginx
COPY nginx.conf nginx.conf

# Script de inicio
RUN cat > start.sh << 'EOF'
#!/bin/bash

echo "ğŸš€ Iniciando PetManager en Render..."

# Iniciar Docker daemon en background
dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2376 &

# Esperar a que Docker estÃ© listo
echo "â³ Esperando Docker daemon..."
timeout 30s bash -c 'until docker info > /dev/null 2>&1; do sleep 1; done'

if [ $? -ne 0 ]; then
    echo "âŒ Error: Docker daemon no se iniciÃ³ correctamente"
    exit 1
fi

echo "âœ… Docker daemon iniciado"

# Construir e iniciar servicios
echo "ğŸ—ï¸ Construyendo servicios..."
docker-compose build --parallel

echo "ğŸš€ Iniciando servicios..."
docker-compose up --remove-orphans

EOF

RUN chmod +x start.sh

# Exponer puerto 80 (nginx)
EXPOSE 80

# Comando de inicio
CMD ["./start.sh"]